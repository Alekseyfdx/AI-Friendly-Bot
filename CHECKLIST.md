# Полный чек-лист приёмки и регресса

Ниже приведён полный список проверок для бота и локальной панели мониторинга. Отмечайте пункты как PASS/FAIL/N/A с фиксацией критичности и ответственного.

## 0) Организация проверки
- [ ] Определён один владелец приёмки и один ответственный за фиксацию багов/решений.
- [ ] Принята шкала статусов: PASS / FAIL / N/A и уровни критичности (Blocker/Critical/Major/Minor).
- [ ] Создан общий журнал приёмки: дата, сборка, git-хэш, окружение, список найденных дефектов и решения.

## 1) Окружение и ОС (Windows 11)
- [ ] Windows 11 актуален (обновления безопасности установлены).
- [ ] План электропитания — «Высокая производительность», спящий режим/гибернация отключены.
- [ ] Синхронизация времени по NTP включена (UTC корректный; смещение ≤ 1 сек).
- [ ] Доступ на биржу/Telegram/OpenAI не блокируется локальным firewall/прокси (при необходимости внесены исключения для исходящих подключений).

## 2) Python 3.12.10 и зависимости
- [ ] `python --version` → 3.12.10 (x64), добавлен в PATH.
- [ ] Создан и активирован venv, зависимости установлены из `requirements.txt`, сборка воспроизводима (`pip freeze` сохранён).
- [ ] Нет конфликтов версий (отсутствуют предупреждения при установке).
- [ ] На Windows корректно ставятся бинарные пакеты (pyarrow, scipy); нет ошибок VC++ Build Tools.
- [ ] Виртуальное окружение фиксировано на машине приёмки (нет смешения с глобальными пакетами).

## 3) Секреты и конфигурация
- [ ] `.env` существует, не лежит в Git, содержит валидные ключи: биржа, OpenAI, Telegram, `DASHBOARD_TOKEN`.
- [ ] `config_master.yaml` присутствует; значения согласованы с ТЗ (режимы, risk, frequency, sl/tp, llm, telegram, dashboard).
- [ ] Правило приоритета выполняется: ENV > YAML > дефолты.
- [ ] Переключатель `hard_lock_live=true` по умолчанию; переход в live требует двойного подтверждения (ENV-флаг + YAML).
- [ ] Чувствительные значения не печатаются в логах.

## 4) Запуск/остановка, жизненный цикл
- [ ] Бот запускается без ошибок из корня проекта (paper-режим).
- [ ] Корректная остановка по Ctrl+C, повторный запуск проходит без артефактов (нет залипших процессов/портов).
- [ ] При падении процесс перезапускается настроенным методом (Task Scheduler/NSSM), состояние восстанавливается.

## 5) Горячая перезагрузка конфигурации
- [ ] Изменение `config_master.yaml` подхватывается без рестарта ≤ 5 сек.
- [ ] При некорректном YAML бот не падает: остаётся на последней валидной конфигурации, лог содержит понятную ошибку.
- [ ] Изменения whitelisted-параметров отражаются в логике в течение одного цикла.

## 6) Источники данных и таймфреймы
- [ ] Подтягиваются бары для `main: 15–30s`, `filter: 5m`, `regime: 15m` (или как задано).
- [ ] Время баров в UTC, нет рассинхронизации между TF.
- [ ] В тесте коротких отключений сети данные корректно догоняются, пропусков нет (или явно помечены).

## 7) Индикаторы и расчёты
- [ ] RSI, EMA(9/21), MACD(3/10/16), BB(12/1.8), ATR(14), VWAP, OBV — считаются корректно, одинаково в логе и UI.
- [ ] Граничные случаи (короткая история) обрабатываются без исключений (возвращают «нет сигнала»).
- [ ] Нет деления на ноль, NaN/inf фильтруются.

## 8) Определение рыночного режима
- [ ] `trend/range/breakout/low_vol` корректно классифицируются на контрольных участках.
- [ ] Порог `trend_min_slope`, `bb_squeeze_threshold` применяются из YAML и видны в логе.
- [ ] Режим записывается в память сделки (для каждой записи).

## 9) Генерация сигналов (Strategy)
- [ ] Правила входа/выхода для LONG/SHORT соответствуют ТЗ (EMA, MACD-hist динамика, RSI, VWAP, sentiment).
- [ ] Фильтр `filter_price_vs_vwap` работает.
- [ ] `min_signal_confidence` учитывает динамическую корректировку TFC и часовые коррекции символа.
- [ ] В spot-режиме SHORT либо отключён, либо корректно интерпретирован как FLAT (в зависимости от настроек).

## 10) Контроллер частоты (TFC)
- [ ] Цель `target_trades_per_hour=10` достигается в paper-режиме на репрезентативном отрезке ≥ 2 часа без нарушения риск-лимитов.
- [ ] При недоборе частоты TFC плавно снижает порог конфиденса и/или включает умеренно агрессивную маршрутизацию, но не ломает RiskEngine.
- [ ] При переборе частоты/плохом fill-rate — агрессию снижает.
- [ ] Реальное `TPh` и `fill-rate` видны в UI и логах.

## 11) RiskEngine
- [ ] Ограничения: `daily_max_loss_pct`, `max_loss_streak`, `max_exposure_pct`, `max_open_positions`, `equity_floor_pct` — отрабатывают, сделки блокируются при нарушении.
- [ ] Тайм-менеджмент позиции: tighten SL (X минут), перевод в безубыток (Y минут), принудительное закрытие (Z минут) — выполняются.
- [ ] Cooldown после крупного минуса активируется; ручная пауза через UI/Telegram тоже.
- [ ] Все решения RiskEngine логируются (причина отказа/допуска).

## 12) Исполнение (Execution) и биржа
- [ ] Выбор maker/taker по режимам (`range→maker`, `trend/breakout→taker`) — работает.
- [ ] Округление цены/объёма по биржевым шагам; проверка минимального notional.
- [ ] Проскальзывание учитывается и ограничивается `slippage_limit_pct` (сделка отклоняется при превышении).
- [ ] Комиссии в обоих режимах (paper/live) учитываются корректно; доли maker/taker фиксируются.
- [ ] В spot-режиме плечо не используется; в futures — `max_exposure_pct` соблюдается.

## 13) PnL, комиссии, налоги
- [ ] Для каждой сделки считаются: gross, fees, tax, net_after_tax (налог применяется только к положительному net, по ставке из YAML).
- [ ] Сумма дневных net в Trades = pnl_day_net в Overview/UI.
- [ ] В UI явно помечено «после налога (оценка)».

## 14) Память и отчёты
- [ ] Запись в Parquet/SQLite стабильна на Windows (нет проблем с блокировками).
- [ ] В запись попадает весь контекст (индикаторы, режим, sentiment, исполнение, риск, причины).
- [ ] `retention_days` применяется (старые данные удаляются/архивируются).
- [ ] Ночной отчёт формируется в `/reports/`, открывается, данные сходятся со сводкой UI.

## 15) Ежечасная переоценка (5m за 12h)
- [ ] Планировщик запускает перерасчёт каждый час; ручной запуск из UI/Telegram работает.
- [ ] Для каждого символа сохраняются корректировки (confidence/SL/TP мульты, режим, средний ATR); применяются в следующем цикле.
- [ ] При ошибке источника данных перерасчёт не валит основной цикл (логируется и пропускается).

## 16) LLM-советник (OpenAI, gpt-3.5-turbo)
- [ ] При `enable_llm_advisor=true` и наличии ключа — запросы уходят, таймаут соблюдается, деградация при ошибках корректная (используется базовый сигнал).
- [ ] Промпт соответствует mode advisor_only (ИИ не исполняет сделки, только рекомендация).
- [ ] Порог `llm.min_confidence` применяется: ниже порога сигнал → FLAT.
- [ ] В памяти фиксируются решения ИИ и их влияние (для A/B анализа).
- [ ] При `enable_llm_advisor=false` стратегия работает автономно.

## 17) Telegram (уведомления и 20 команд)
- [ ] Уведомления приходят только по факту входов/закрытий и инцидентам (kill-switch, drawdown), без спама.
- [ ] Все 10 инфо-команд возвращают корректные данные (status/positions/lasttrades/equity/pnl/regime/risk/config/latency/hourly_summary).
- [ ] Все 10 управляющих команд выполняются (start/stop/flat/switch_mode/set/pause/resume/reload_config/set_symbols/force_hourly) с подтверждением для критичных.
- [ ] Доступ только для `admin_chat_ids` (неадминам — отказ и запись в лог).
- [ ] Rate-limit сообщений соблюдается; нет дубликатов.

## 18) Локальный dashboard.html (один файл)
- [ ] Открывается на `http://127.0.0.1:8787/` только при запущенном боте; при остановке — «Bot offline».
- [ ] Все вкладки работают: Overview/Charts/Positions/Trades/Regime&Sentiment/Risk&Frequency/Config/Reports/Logs/Control.
- [ ] WebSocket обновляет графики и таблицы; при разрыве UI уходит в pull-режим (без падения).
- [ ] Все POST требуют `X-Auth-Token`; без него — 401/403. С токеном — действия выполняются и аудируются.
- [ ] Сервер слушает только 127.0.0.1 (проверено `netstat`), из внешней сети недоступен.
- [ ] Маркеры входов/выходов/SL/TP на графике совпадают с памятью; PnL-цвета правильные.

## 19) API-сервер и безопасность
- [ ] `/api/health` → ok только после полной инициализации бота.
- [ ] Все GET возвращают корректные JSONы, поля согласованы со схемой.
- [ ] Все POST `/api/control/*` валидируют вход, проверяют whitelist, пишут аудит (кто/когда/что/старое/новое/результат).
- [ ] Секреты не попадают в ответы/логи/UI.
- [ ] CORS отключён (не нужен на localhost), SameSite=Strict для cookie (если используются).

## 20) Логи и мониторинг
- [ ] Включена ротация логов по размеру, не менее 3 бэкапов.
- [ ] JSON-лог событий доступен для быстрой фильтрации (trade_id/order_id).
- [ ] Есть отдельный аудит изменений из UI/Telegram (отдельный файл).
- [ ] Ошибки сетевых вызовов (биржа/LLM) ретраятся с backoff; в логах — одно событие на серию, без лавины.

## 21) Производительность и надёжность
- [ ] На 2 символах при ≥10 сделках/час CPU ≤ разумного порога (зафиксирован в журнале), память не растёт (утечек нет) в 2-часовом прогоне.
- [ ] В dashboard ограничена частота перерисовок (нет «дёрганья»).
- [ ] При рестарте прямо во время открытой позиции состояние корректно восстанавливается (позиции подтягиваются, SL/TP активны).
- [ ] При кратковременных сетевых отказах бот продолжает работу после восстановления без ручного вмешательства.

## 22) Windows-специфика
- [ ] Длинные пути включены при необходимости (LongPathsEnabled=1) — проект собирается без ошибок.
- [ ] Task Scheduler/NSSM корректно держит процесс; при падении есть автоперезапуск.
- [ ] Порт 8787 не занят другими процессами; firewall не блокирует loopback.
- [ ] Кодировка логов/файлов UTF-8; кириллица отображается нормально.

## 23) KPI и результаты тестов
- [ ] Выполнен бумажный прогон ≥ 2 часа, достигнута средняя частота ≥10 сделок/час без нарушений RiskEngine.
- [ ] Проведён A/B тест LLM off/on по суткам, собрана сводка: изменение winrate/PnL/средние удержания.
- [ ] Согласованы и зафиксированы стартовые параметры для рабочего paper-режима.

## 24) Готовность к live (Go/No-Go)
- [ ] Все Blocker/Critical закрыты, регресс пройден.
- [ ] `hard_lock_live=false` — переключение live осознанно, в журнале — отметка и конфигурация.
- [ ] На демо-аккаунте/минимальных объёмах протестированы ордера (округления/шаги/комиссии).
- [ ] Откатный план: как вернуться в paper мгновенно (и кто принимает решение).

## 25) Документация и передача
- [ ] Обновлён README (как запускать, где логи/отчёты, как открыть dashboard, как задать токен).
- [ ] Приложен шаблон `config_master.yaml` с комментариями и диапазонами допустимых значений.
- [ ] Приложен список whitelist-параметров и их валидаций.
- [ ] Зафиксирована версия `requirements.txt` и `pip freeze`.
- [ ] Сформирован итоговый отчёт приёмки с KPI, скринами UI и логами.

## Мини-чек-листы сценариев

### A. Недобор частоты
- [ ] При понижении активности рынка TFC снижает `min_signal_confidence`, растёт доля taker в тренде, RiskEngine остаётся в норме; частота подтягивается или фиксируется разумный недобор.

### B. Серия убыточных сделок
- [ ] На 3-й подряд убыточной включается cooldown, сделки блокируются; UI и Telegram показывают причину.

### C. Всплеск волатильности
- [ ] При росте ATR SL/TP мульты подстраиваются (из часовой адаптации), проскальзывание не превышает лимит; если превышает — вход запрещён.

### D. Сбой OpenAI
- [ ] Таймаут/ошибка не ломает стратегию — используется базовый сигнал, в логах единичное предупреждение, UI остаётся стабильным.

### E. Сбой биржи/сети
- [ ] Временный обрыв приводит к ожиданию/ретраю; после восстановления состояние корректное, лишних сделок нет.

### F. Безопасность UI
- [ ] POST без `X-Auth-Token` даёт 401/403; с неверным токеном — 403; с верным — действия выполняются и аудируются.
- [ ] Сервер слушает только 127.0.0.1; извне не открыть.

### G. Горячая подгрузка
- [ ] Изменение `signals.min_signal_confidence` отражается в логике через один цикл (видно в логах/summary UI).
- [ ] Некорректный YAML не приводит к падению: остаётся предыдущая валидная конфигурация.

## Критерии готовности
- [ ] Все пункты разделов 1–22 PASS.
- [ ] KPI раздела 23 выполнены.
- [ ] Go/No-Go согласован; при No-Go есть список доработок со сроками.
- [ ] Документация и freeze-версии переданы.
